{"ts":1350809260993,"silentsave":true,"restoring":false,"patch":[[]],"length":0}
{"contributors":[],"silentsave":false,"ts":1350809430953,"patch":[[{"diffs":[[1,"#!/bin/env node\n\nvar http = require('http'),\n    xml2js = require('xml2js'),\n    zlib = require('zlib'),\n    fs = require('fs'),\n    url = require('url'),\n    mime = require('./mime').types;\n\nfunction regexId(string) {\n    var result = /flashvars=\"([^\"]+)\"/.exec(string);\n    if(!result) {\n        result = /secure,([^\"]+)\"/.exec(string);\n    }\n    return result ? result[1] : null;\n}\n\nfunction getId(pageUrl, cb) {\n    var options = url.parse(pageUrl);\n\n    try {\n        http.get(options, function(res) {\n            var headers = res.headers;\n\n            if(headers.location) {\n\n                pageUrl = headers.location;\n                options = url.parse(pageUrl);\n\n                http.get(options, function(res) {\n                    var gunzip = zlib.createGunzip();\n\n                    res.pipe(gunzip);\n\n                    var html = '';\n\n                    gunzip.on('data', function(data) {\n                        html += data;\n                    });\n\n                    gunzip.on('end', function() {\n                        var id = regexId(html);\n                        cb(id);\n                    });\n\n                    gunzip.on('error', function(err) {\n                        cb();\n                    });\n\n                });\n\n            } else {\n                var gunzip = zlib.createGunzip();\n\n                res.pipe(gunzip);\n\n                var html = '';\n\n                gunzip.on('data', function(data) {\n                    html += data;\n                });\n\n                gunzip.on('end', function() {\n                    var id = regexId(html);\n                    cb(id);\n                });\n\n                gunzip.on('error', function(err) {\n                    cb();\n                });\n            }\n        });\n    } catch(err) {\n        cb();\n    }\n}\n\nfunction getURL(id, cb) {\n    var pageUrl = 'http://interface.bilibili.tv/playurl?' + id;\n    var options = url.parse(pageUrl);\n\n    try {\n        http.get(options, function(res) {\n            res.setEncoding('utf8');\n\n            var xml_raw = '';\n            res.on('data', function(data) {\n                xml_raw += data;\n            });\n\n            res.on('end', function() {\n                var parser = new xml2js.Parser();\n                parser.parseString(xml_raw, function(err, result) {\n                    if(err) {\n                        cb(null);\n                    } else {\n                        var list_url = [];\n                        for(var i in result.video.durl) {\n                            list_url.push(result.video.durl[i].url[0]);\n                        }\n                        cb(list_url);\n                    }\n                });\n            });\n\n            res.on('error', function(err) {\n                cb();\n            });\n\n        });\n    } catch(err) {\n        cb();\n    }\n}\n\nvar template = fs.readFileSync('template.html');\n\nvar server = new http.Server();\n\nserver.on('request', function(req, res) {\n\n    var get = url.parse(req.url, true);\n    if(get.pathname == '/') {\n        if(get.query.url) {\n            getId(get.query.url, function(id) {\n                getURL(id, function(list) {\n                    if(list) {\n                        res.writeHead(200, {\n                            'Content-Type': mime['json']\n                        });\n                        res.end(JSON.stringify(list));\n                    } else {\n                        res.writeHead(404, {\n                            'Content-Type': mime['json']\n                        });\n                        res.end();\n                    }\n                });\n            });\n        } else {\n            res.writeHead(200, {\n                'Content-Type': 'text/html'\n            });\n            res.write(template);\n            res.end();\n        }\n    } else {\n        var pathStatic = /\\/static\\/([\\w]+).([\\w]+)/.exec(get.pathname);\n        if(pathStatic) {\n            var file_name = pathStatic[1],\n                file_type = pathStatic[2];\n            res.writeHead(200, {\n                'Content-Type': mime[file_type],\n                'Cache-Control': 'max-age=604800'\n            });\n            fs.readFile('static/' + file_name + '.' + file_type, 'binary', function(err, data) {\n                if(!err) {\n                    res.write(data, 'binary');\n                }\n                res.end();\n            });\n        } else {\n            res.writeHead(404, {\n                'Content-Type': 'text/html'\n            });\n            res.end('Σ( ° △ °|||');\n        }\n    }\n\n});\n\nserver.listen(3000);\n\nprocess.on('uncaughtException', function(err) {\n    fs.open('exception.log', 'a', 766, function(e, id) {\n        fs.write(id, err + '\\n', null, 'utf8', function() {\n            fs.close(id);\n        });\n    });\n});"]],"start1":0,"start2":0,"length1":0,"length2":4774}]],"length":4774,"saved":false}
{"ts":1350809485463,"patch":[[{"diffs":[[0,"sten(300"],[-1,"0"],[1,"1"],[0,");\n\nproc"]],"start1":4547,"start2":4547,"length1":17,"length2":17}]],"length":4774,"saved":false}
{"ts":1350809491944,"patch":[[{"diffs":[[0,"sten(300"],[-1,"1"],[1,"0"],[0,");\n\nproc"]],"start1":4547,"start2":4547,"length1":17,"length2":17}]],"length":4774,"saved":false}
{"ts":1350809498960,"patch":[[{"diffs":[[0,"ten("],[-1,"300"],[1,"8"],[0,"0);\n"]],"start1":4548,"start2":4548,"length1":11,"length2":9}]],"length":4772,"saved":false}
